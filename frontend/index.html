<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeAgent - AI Agent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.6;
        }
        
        .brutalist-button {
            background-color: #0f0;
            color: #000;
            border: 3px solid #0f0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .brutalist-button:hover {
            background-color: #0a0;
            border-color: #0a0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .brutalist-button:active {
            transform: scale(0.95);
        }
        
        .brutalist-button:disabled {
            background-color: #333;
            border-color: #333;
            cursor: not-allowed;
        }
        
        .brutalist-input {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            width: 100%;
        }
        
        .brutalist-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .brutalist-textarea {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }
        
        .brutalist-textarea:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .brutalist-card {
            background-color: #000;
            border: 3px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .brutalist-card h3 {
            color: #0f0;
            border-bottom: 2px solid #0f0;
            padding-bottom: 10px;
            margin-top: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }
        
        .status-offline {
            background-color: #666;
        }
        
        .status-error {
            background-color: #f00;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .terminal-output {
            background-color: #000;
            border: 2px solid #0f0;
            padding: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .terminal-line {
            margin-bottom: 4px;
        }
        
        .terminal-line.error {
            color: #f00;
        }
        
        .terminal-line.success {
            color: #0f0;
        }
        
        .terminal-line.info {
            color: #0af;
        }
        
        .terminal-line.warning {
            color: #fa0;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
        }
        
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #0f0;
        }
        
        .chat-message.user {
            background-color: #001a00;
            border-left-color: #0f0;
        }
        
        .chat-message.assistant {
            background-color: #000;
            border-left-color: #0af;
        }
        
        .chat-message.system {
            background-color: #1a1a00;
            border-left-color: #fa0;
        }
    </style>
</head>
<body class="bg-black text-green-400">
    <div x-data="vibeagentDashboard()" class="min-h-screen">
        <!-- Header -->
        <header class="border-b-4 border-green-400 p-6">
            <div class="container mx-auto">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold tracking-wider">VIBEAGENT</h1>
                        <p class="text-green-600 mt-1">AI AGENT SYSTEM</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span class="status-indicator" :class="statusIndicatorClass"></span>
                            <span x-text="statusText"></span>
                        </div>
                        <button @click="toggleTerminal" class="brutalist-button">TERMINAL</button>
                        <button @click="refreshData" class="brutalist-button">REFRESH</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-6">
            <!-- Stats Section -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="brutalist-card">
                    <h3>AGENT STATUS</h3>
                    <p class="text-3xl font-bold mt-4" x-text="healthStatus.agent?.status || 'UNKNOWN'"></p>
                    <p class="text-sm text-green-600 mt-2" x-text="healthStatus.agent?.message || ''"></p>
                </div>
                <div class="brutalist-card">
                    <h3>DATABASE</h3>
                    <p class="text-3xl font-bold mt-4" x-text="healthStatus.database?.status || 'UNKNOWN'"></p>
                    <p class="text-sm text-green-600 mt-2" x-text="healthStatus.database?.message || ''"></p>
                </div>
                <div class="brutalist-card">
                    <h3>SKILLS</h3>
                    <p class="text-3xl font-bold mt-4" x-text="skills.length"></p>
                    <p class="text-sm text-green-600 mt-2">Available skills</p>
                </div>
                <div class="brutalist-card">
                    <h3>UPTIME</h3>
                    <p class="text-3xl font-bold mt-4" x-text="uptime"></p>
                    <p class="text-sm text-green-600 mt-2">Server uptime</p>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="brutalist-card mb-8">
                <h3>AGENT CHAT</h3>
                <div class="mt-6">
                    <div class="chat-container terminal-output mb-4" id="chatOutput">
                        <template x-for="msg in chatMessages" :key="msg.id">
                            <div class="chat-message" :class="msg.role">
                                <div class="font-bold text-sm mb-1" x-text="msg.role.toUpperCase()"></div>
                                <div x-text="msg.content"></div>
                            </div>
                        </template>
                    </div>
                    <div class="flex gap-4">
                        <textarea 
                            x-model="chatInput" 
                            @keydown.enter.prevent="sendChatMessage"
                            placeholder="Type your message here..."
                            class="brutalist-textarea"
                            rows="3"
                        ></textarea>
                        <button @click="sendChatMessage" :disabled="isProcessing" class="brutalist-button self-end">
                            <span x-show="isProcessing">SENDING...</span>
                            <span x-show="!isProcessing">SEND</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Agent Control Panel -->
            <div class="brutalist-card mb-8">
                <h3>AGENT CONTROLS</h3>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Max Iterations</label>
                        <input type="number" x-model="maxIterations" class="brutalist-input" min="1" max="100">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Timeout (seconds)</label>
                        <input type="number" x-model="timeoutSeconds" class="brutalist-input" min="10" max="3600">
                    </div>
                    <div class="flex items-end">
                        <button @click="executeAgent" :disabled="isProcessing" class="brutalist-button w-full">
                            <span x-show="isProcessing">EXECUTING...</span>
                            <span x-show="!isProcessing">EXECUTE QUERY</span>
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-bold mb-2">Query</label>
                    <textarea x-model="queryInput" class="brutalist-textarea" rows="3" placeholder="Enter your query for the agent..."></textarea>
                </div>
            </div>

            <!-- Skills Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Skills List -->
                <div class="brutalist-card">
                    <h3>AVAILABLE SKILLS</h3>
                    <div class="mt-6 space-y-4" id="skillsList">
                        <template x-for="skill in skills" :key="skill.name">
                            <div class="flex justify-between items-center border-b border-green-400 pb-2">
                                <div class="flex-1">
                                    <div class="font-bold" x-text="skill.name"></div>
                                    <div class="text-xs text-green-600" x-text="skill.description"></div>
                                    <div class="text-xs text-green-800 mt-1">
                                        <span x-text="skill.category"></span>
                                        <span x-show="skill.enabled" class="ml-2 text-green-400">[ENABLED]</span>
                                        <span x-show="!skill.enabled" class="ml-2 text-red-400">[DISABLED]</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="toggleSkill(skill.name)" :disabled="isProcessing" 
                                        class="brutalist-button text-xs px-3 py-1">
                                        <span x-text="skill.enabled ? 'DISABLE' : 'ENABLE'"></span>
                                    </button>
                                    <button @click="executeSkill(skill.name)" :disabled="isProcessing" 
                                        class="brutalist-button text-xs px-3 py-1">
                                        RUN
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Agent State -->
                <div class="brutalist-card">
                    <h3>AGENT STATE</h3>
                    <div class="mt-6">
                        <template x-if="agentState">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2">State</label>
                                    <p class="brutalist-input" x-text="agentState.state"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Iteration</label>
                                    <p class="brutalist-input" x-text="agentState.iteration"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Last Action</label>
                                    <p class="brutalist-input" x-text="agentState.last_action || 'None'"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">Thoughts</label>
                                    <div class="terminal-output max-h-40">
                                        <template x-for="thought in agentState.thoughts" :key="thought">
                                            <div class="terminal-line" x-text="thought"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="!agentState">
                            <p class="text-green-600">No agent state available</p>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Terminal Output -->
            <div x-show="showTerminal" class="mt-8">
                <div class="brutalist-card">
                    <h3>TERMINAL OUTPUT</h3>
                    <div class="terminal-output mt-6" id="terminalOutput">
                        <template x-for="line in terminalLines" :key="line.id">
                            <div class="terminal-line" :class="line.type" x-text="line.message"></div>
                        </template>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t-4 border-green-400 p-6 mt-12">
            <div class="container mx-auto text-center">
                <p class="text-green-600">¬© 2024 VibeAgent - AI Agent System</p>
                <p class="text-green-800 text-sm mt-2">API: <span x-text="apiUrl"></span></p>
                <p class="text-green-800 text-xs mt-1">Endpoints: /health, /agent/skills, /agent/status, /agent/execute, /agent/chat_with_tools</p>
            </div>
        </footer>
    </div>

    <script>
        function vibeagentDashboard() {
            return {
                // Configuration
                apiUrl: 'http://localhost:8000',
                wsUrl: 'ws://localhost:8000/ws',
                
                // Data
                healthStatus: {
                    agent: { status: 'UNKNOWN', message: 'Loading...' },
                    database: { status: 'UNKNOWN', message: 'Loading...' }
                },
                skills: [],
                agentState: null,
                chatMessages: [],
                chatInput: '',
                queryInput: '',
                maxIterations: 20,
                timeoutSeconds: 300,
                isProcessing: false,
                showTerminal: false,
                terminalLines: [
                    { id: 1, type: "info", message: "ü§ñ VibeAgent Dashboard Initializing..." },
                    { id: 2, type: "info", message: "üì° Connecting to API at http://localhost:8000..." },
                    { id: 3, type: "info", message: "üìä Using legacy API endpoints" }
                ],
                uptime: '0s',
                startTime: Date.now(),

                // Computed properties
                statusText: function() {
                    return this.isProcessing ? "PROCESSING" : "IDLE";
                },
                statusIndicatorClass: function() {
                    return this.isProcessing ? "status-online pulse" : "status-online";
                },

                // Methods
                toggleTerminal: function() {
                    this.showTerminal = !this.showTerminal;
                },

                addTerminalLine: function(message, type = "info") {
                    const id = Date.now();
                    this.terminalLines.push({ id, type, message });
                    
                    if (this.terminalLines.length > 50) {
                        this.terminalLines.shift();
                    }
                    
                    this.$nextTick(() => {
                        const terminal = document.getElementById('terminalOutput');
                        if (terminal) {
                            terminal.scrollTop = terminal.scrollHeight;
                        }
                    });
                },

                addChatMessage: function(role, content) {
                    const id = Date.now();
                    this.chatMessages.push({ id, role, content });
                    
                    this.$nextTick(() => {
                        const chat = document.getElementById('chatOutput');
                        if (chat) {
                            chat.scrollTop = chat.scrollHeight;
                        }
                    });
                },

                fetchHealth: async function() {
                    try {
                        const response = await fetch(`${this.apiUrl}/health`);
                        if (response.ok) {
                            const data = await response.json();
                            this.healthStatus = {
                                agent: { status: data.status || 'unknown', message: data.agent || 'VibeAgent' },
                                database: { status: 'healthy', message: 'Connected' }
                            };
                            this.addTerminalLine("‚úÖ Health check passed", "success");
                        } else {
                            this.addTerminalLine("‚ùå Health check failed", "error");
                        }
                    } catch (error) {
                        this.addTerminalLine(`‚ùå Health check error: ${error.message}`, "error");
                    }
                },

                fetchSkills: async function() {
                    try {
                        const response = await fetch(`${this.apiUrl}/agent/skills`);
                        if (response.ok) {
                            const data = await response.json();
                            this.skills = data.skills || data || [];
                            if (Array.isArray(this.skills)) {
                                this.skills = this.skills.map(skill => ({
                                    name: skill.name || skill,
                                    description: skill.description || 'No description',
                                    category: skill.category || 'general',
                                    enabled: skill.enabled !== false
                                }));
                            }
                            this.addTerminalLine(`‚úÖ Loaded ${this.skills.length} skills`, "success");
                        }
                    } catch (error) {
                        this.addTerminalLine(`‚ùå Skills fetch error: ${error.message}`, "error");
                    }
                },

                fetchAgentState: async function() {
                    try {
                        const response = await fetch(`${this.apiUrl}/agent/status`);
                        if (response.ok) {
                            const data = await response.json();
                            this.agentState = {
                                state: 'idle',
                                iteration: 0,
                                last_action: 'Agent initialized',
                                thoughts: [`Agent: ${data.name}`, `Skills: ${data.skills_count}`, `Created: ${data.created_at}`]
                            };
                        }
                    } catch (error) {
                        console.error('Error fetching agent state:', error);
                    }
                },

                refreshData: async function() {
                    this.addTerminalLine("üîÑ Refreshing data...", "info");
                    await Promise.all([
                        this.fetchHealth(),
                        this.fetchSkills(),
                        this.fetchAgentState()
                    ]);
                },

                sendChatMessage: async function() {
                    if (!this.chatInput.trim() || this.isProcessing) return;
                    
                    const message = this.chatInput.trim();
                    this.addChatMessage('user', message);
                    this.chatInput = '';
                    this.isProcessing = true;
                    
                    this.addTerminalLine(`üì§ Sending chat message...`, "info");
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/agent/chat_with_tools`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: message,
                                max_iterations: this.maxIterations
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.addChatMessage('assistant', data.message || data.response || 'No response');
                            if (data.tool_calls_made > 0) {
                                this.addTerminalLine(`üîß Used ${data.tool_calls_made} tool(s)`, "info");
                            }
                            this.addTerminalLine(`‚úÖ Chat message processed (${data.iterations} iterations)`, "success");
                        } else {
                            const error = await response.json();
                            this.addChatMessage('system', `Error: ${error.error || error.detail || 'Unknown error'}`);
                            this.addTerminalLine("‚ùå Chat message failed", "error");
                        }
                    } catch (error) {
                        this.addChatMessage('system', `Error: ${error.message}`);
                        this.addTerminalLine(`‚ùå Chat error: ${error.message}`, "error");
                    }
                    
                    this.isProcessing = false;
                },

                executeAgent: async function() {
                    if (!this.queryInput.trim() || this.isProcessing) return;
                    
                    const query = this.queryInput.trim();
                    this.queryInput = '';
                    this.isProcessing = true;
                    
                    this.addTerminalLine(`üöÄ Executing agent query: ${query.substring(0, 50)}...`, "info");
                    this.addChatMessage('user', query);
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/agent/chat_with_tools`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: query,
                                max_iterations: this.maxIterations
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.message) {
                                this.addChatMessage('assistant', data.message);
                            }
                            if (data.tool_results && data.tool_results.length > 0) {
                                this.addTerminalLine(`üîß Used ${data.tool_results.length} tool(s)`, "info");
                            }
                            this.addTerminalLine(`‚úÖ Agent execution completed (${data.iterations} iterations)`, "success");
                        } else {
                            const error = await response.json();
                            this.addChatMessage('system', `Error: ${error.error || error.detail || 'Unknown error'}`);
                            this.addTerminalLine("‚ùå Agent execution failed", "error");
                        }
                    } catch (error) {
                        this.addChatMessage('system', `Error: ${error.message}`);
                        this.addTerminalLine(`‚ùå Execution error: ${error.message}`, "error");
                    }
                    
                    this.isProcessing = false;
                    await this.fetchAgentState();
                },

                toggleSkill: async function(skillName) {
                    // Old API doesn't have enable/disable, just show a message
                    this.addTerminalLine(`‚ÑπÔ∏è  Skill management not available in current API version`, "warning");
                },

                executeSkill: async function(skillName) {
                    if (this.isProcessing) return;
                    
                    this.isProcessing = true;
                    this.addTerminalLine(`üîß Executing skill: ${skillName}`, "info");
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/agent/execute`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                query: `Use ${skillName} skill`,
                                max_iterations: this.maxIterations,
                                timeout_seconds: this.timeoutSeconds
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.addChatMessage('assistant', JSON.stringify(data.result || data.response, null, 2));
                            this.addTerminalLine(`‚úÖ Skill executed successfully`, "success");
                        } else {
                            const error = await response.json();
                            this.addChatMessage('system', `Error: ${error.detail || 'Unknown error'}`);
                            this.addTerminalLine("‚ùå Skill execution failed", "error");
                        }
                    } catch (error) {
                        this.addChatMessage('system', `Error: ${error.message}`);
                        this.addTerminalLine(`‚ùå Skill error: ${error.message}`, "error");
                    }
                    
                    this.isProcessing = false;
                },

                updateUptime: function() {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    if (elapsed < 60) {
                        this.uptime = `${elapsed}s`;
                    } else if (elapsed < 3600) {
                        this.uptime = `${Math.floor(elapsed / 60)}m ${elapsed % 60}s`;
                    } else {
                        const hours = Math.floor(elapsed / 3600);
                        const minutes = Math.floor((elapsed % 3600) / 60);
                        this.uptime = `${hours}h ${minutes}m`;
                    }
                },

                init: function() {
                    this.addTerminalLine("üîÑ Fetching initial data...", "info");
                    this.refreshData();
                    
                    // Refresh data every 30 seconds
                    setInterval(() => {
                        this.refreshData();
                        this.fetchAgentState();
                    }, 30000);
                    
                    // Update uptime every second
                    setInterval(() => {
                        this.updateUptime();
                    }, 1000);
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('alpine:init', () => {
            Alpine.store('dashboard', vibeagentDashboard);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                const terminal = document.getElementById('terminalOutput');
                if (terminal) {
                    terminal.innerHTML = '';
                }
            }
        });
    </script>
</body>
</html>